---
title: "Create data products"
author: "K Todd-Brown (ktoddbrown@gmail.com)"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup}
library(tidyverse)
library(SoilDataR) #library(devtools); install_github("ktoddbrown/soilDataR")
```

```{r soilData}
#######ISCN3 - soil carbon, bulk density, clay percentage
#ISCN3 <- processData_ISCN3(dataDir='~/Documents/Datasets/ISCN_3/', verbose=TRUE)
#save(ISCN3, file='~/Documents/Datasets/ISCN_3/ISCN3.RData')

load('~/Documents/Datasets/ISCN_3/ISCN3.RData')

##Add new indecies for possible duplications
ISCN3$field <- ISCN3$field %>% 
  mutate(fieldID_byString = group_indices(., lat, lon, 
                                        layer_bottom, layer_top, observation_date)) %>%
  mutate_at(c('layer_bottom', 'layer_top', 'observation_date'),
            funs(num=round(as.numeric(as.character(.)), 0))) %>%
  mutate_at(c('lat', 'lon'), funs(num=round(as.numeric(as.character(.)), 1))) %>%
  mutate(fieldID_byApprox = group_indices(., lat_num, lon_num, 
                                         layer_bottom_num, layer_top_num,
                                   observation_date_num)) %>%
  select(-ends_with('_num'))

##Identify non-located entries
noLocation <- ISCN3$field %>%
  filter(is.na(lat), is.na(lon), 
         is.na(layer_bottom), is.na(layer_top),
         is.na(observation_date)) %>%
  select(ends_with('_name'), starts_with('fieldID')) %>%
  unique()

##Identify conflicting entries
problematicFieldEntries <- ISCN3$field %>%
  filter(!is.na(lat), !is.na(lon), !is.na(layer_bottom), !is.na(layer_top),
         !is.na(observation_date)) %>% #only look at well defined sites
  select(-lat, -lon, -layer_bottom, -layer_top, -observation_date, 
         -fieldID, -fieldID_byApprox) %>% #look at non-identifying columns
  group_by(fieldID_byString) %>% #group by entry matching
  gather(key='header', value='value', -fieldID_byString, na.rm=TRUE) %>%
  group_by(fieldID_byString, header) %>%
  unique() %>%
  tally()  %>% #count up number of unique values for that header
  filter(n > 1) #only care about headers with more then one value
  
#dim(noLocation)
#ISCN3$field$fieldID_byString %>% unique %>% length
#problematicFieldEntries$fieldID_byString %>% unique %>% length
#problematicFieldEntries %>% arrange(-n) %>% head

##recast the lat-lon as numerics
ISCN3$field <- ISCN3$field  %>%
  mutate(lat=as.numeric(lat), lon=as.numeric(lon))

##Add the hard coded units
hardUnits.df <- ISCN3$ISCNKey %>% filter(type == 'value', !is.na(hardUnit)) %>% select(var, hardUnit)
ISCN3$measure <-  ISCN3$measure %>% 
  left_join(select(filter(ISCN3$ISCNKey, type=='value'), var, hardUnit), by='var') %>%
  mutate(unit=if_else(grepl('\\w', unit) , as.character(unit), hardUnit))

##Check country based on lat/lon
countryCheck <- ISCN3$field %>%
  filter(is.finite(lat+lon)) %>%
  select(lat, lon, country) %>%
  mutate(country_renamed=recode(country, "United States"="USA",
                        "Federated States of Micronesia" = "Micronesia",
                        "Korea, Republic of"="South Korea",
                        "Congo (Democratic Republic of the)" = 
                          "Democratic Republic of the Congo",
                        "Unknown"=as.character(NA))) %>%
  unique() %>%
  mutate(mapsID=as.factor(maps::map.where(y=lat, x=lon))) %>%
  mutate(mapsID=recode(mapsID,
                       'Puerto Rico'='USA:Puerto Rico',
                       'Virgin Islands, US:Saint Croix'=
                         'USA:Virgin Islands, US:Saint Croix',
                       'Virgin Islands, US:Saint John'=
                         'USA:Virgin Islands, US:Saint John',
                       'Virgin Islands, US:Saint Thomas'=
                         'USA:Virgin Islands, US:Saint Thomas',
                       'Guam'='USA:Guam')) %>%
  group_by(country_renamed, country, mapsID) %>%
  mutate(countryMatch = as.logical(grepl(as.character(country_renamed[1]),
                                         as.character(mapsID))),
         onlyOne = xor(is.na(country_renamed), is.na(mapsID)))
  
#countryCheck %>% filter(!countryMatch) %>% summary
#temp <- countryCheck %>% filter(!countryMatch & !onlyOne)
```

```{r constructLocation}
locationID <- ISCN3$field %>% 
  anti_join(noLocation) %>%
  full_join(countryCheck %>% 
              filter(countryMatch | onlyOne) %>% 
              select(-countryMatch, -onlyOne))
```